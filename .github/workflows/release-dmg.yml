name: Release DMG

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Core package tests
        working-directory: src/CoreMarkdownPreview
        run: swift test

      - name: Build release app (unsigned)
        env:
          DERIVED_DATA_PATH: ${{ runner.temp }}/mdp-dd
        run: |
          xcodebuild \
            -project MarkdownPreview.xcodeproj \
            -scheme MarkdownPreviewApp \
            -configuration Release \
            -derivedDataPath "$DERIVED_DATA_PATH" \
            clean build \
            CODE_SIGNING_ALLOWED=NO

      - name: Create DMG
        env:
          DERIVED_DATA_PATH: ${{ runner.temp }}/mdp-dd
        run: bash scripts/create_dmg.sh

      - name: Verify DMG output
        run: |
          ls -la dist
          test -n "$(ls -1 dist/*.dmg 2>/dev/null)"

      - name: Upload DMG to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.dmg
          generate_release_notes: true
